# Встреча я, Абрамов, Кузнецов


>- Адаптивность к изменению бизнес-процессов, порядка шагов, добавлению новых сценариев, новых шагов, новых бизнес-правил.
> 
Надо дать конкретные оценки, метрики качества

>- Единые правила для всех точек возврата (лк, кассы, ...). Конкретная точка может лишь сужать условия возврата, ограничивая доступность возврата
>  по тем или иным сценариям.

>Функциональные требования
>- Работа через поручение на возврат
>- Логирование каждой операции в рамках исполнения поручения.
>- Логирование действий пользователя с поручением.
>- Просмотр истории поручения.
>- Уведомления о "зависших" поручениях. Возможность настроить, кого, как и в каких ситуациях уведомлять.
> 
По сути все верно, переформулировать. Говорить, что работа происходит через документ, с состоянием, жизненным циклом и историей. 
Тогда логирование следует автоматом.

>Настройка правил возврата находится в условно другой предметной области (действительно другой?).
 
Предметная область та же, это все контекст заказа. Но храним их пока в базисе, делаем АПИ с этим правилам, которым будут работать как ACL.
При создании поручения сохраняем копии данных из других контекстов. Данные проходят через ACL. Копии правил тоже сохраняем.
В поручении пишем, какие правила мы применили. 
Делаем АПИ к правилам возврата, потом надо убедится, что к ним, никто кроме как это АПИ не обращается.
Контроль условий для входа сценрий, необходимых параметров - на точке входа в процесс, т.е. при создании поручения.

Поручение имеет статус черновик, далее пользователь подтверждает, и поручение в процессе. Далее идет синхронизация, 
далее повторная проверка по правилам, и далее уже действия.

История: храним локально + скидываем данные в систему бизнес-аудит  (elastic seacrch). Важно: с таблицей истории можно делать только insert и select
Сама модель может иметь ленивую ссылку на историю.

Поручение реализует интерфейс документа. Но только ментально, на стадии компиляции не должно быть связи
Надо начать с постоение АПИ для почта-банка и сайта, по ним можно посроить и внутрее АПИ
В поручении мы дублируем свойства заказа.
Пока реализуем один процесс - автоматический возврат на ту же карту. 

## Summary встречи от Вани

* Архитектура описывает как мы достигаем требований функциональных и нефункциональных (используются метрики качества).
* В требованиях указываем метрики, к которым стремимся. Это позволит понять, соответсвует ли архитектура указанным
  требованиям или нет. Появляется конкретика.
* Anti corruption layer - со стороны контента
* Заявка на возврат от пользователя (факт желания и предусловаия) это один документ, поручение на возврат -
  сформированный согласно условиям документ, готовый к исполнению (всё посчитано и может быть возвращено).
* Как распиливать монолит - Контекст в базе обкладывается api; определяется, кто ходит к данным (мониторим
  пользователей, которые ходят к данным); переключается хождение напрямую на api; контекст выностися в отдельную базу и
  сервис.
* Что делаем с Global return rules в базе используем или модифицируем? - делаем api под наши нужды (DTO), а в базе
  используем то, что есть (через DAO), либо модифицируем базу. Идем от потребителя и удобных нам DTO.
* Контроль инвариантов - проверка корректности данных. Всегда на точке входа в процесс. Далее в процессе мы доверяем
  данным.
* Не факт, что нужно создавать поручение уже с реквизитами. Запрос реквизитов может быть частью процесса.
* Заявка - требует подтверждения. Поручение - документ не требующий подтверждения, готовый к исполнению.
* Повротная провекра на момент подтверждения заявки от пользователя - может быть частью процесса обработки поручения.
  Проверки проводятся с учетом времени, когда пользователь дал подтверждения (как бы в момент этого подтвердения)
* Процесс работы по поручению запоминает на каком этапе он сейчас выполняется. Если процесс застрял, можно пнуть его с
  того места, на котором он застрял.
* Логирование истории поручения - В идеали через класс систем Аудит. Под капотом - складывается в кафку стандартная
  структура в виде json. В реальности - пишем в таблицу. Над таблицей истории возможны только две опреации - select и
  insert.
* История содержит ссылку на модель. Поручение one-to-many к записям в таблице истории.
* Выделить общие свойства для документа. Задокументировать их в виде соглашения. Остальные документы в дальнейшем
  создаются на основе соглашения.
* Сразу вынести предметную область возвратов в отдельную базу. Посчитать количество заявлений на возврат и прикинуть
  предполагаемый размер базы.
* Для начала описываем ПОВЕДЕНИЕ (интерфейс), потом описываем необходимые структуры для этого повдеения. В итоге
  получаем понимание о том какими свойствами обладают объекты.
* НЕ БОИМСЯ в своем контексте ДУБЛИРОВАТЬ данные из других контекстов. Не полагаемся на ссылки. Это позволяет понимать в
  каком состоянии мы находились в истории.


Задачи
- Отредактировать - обновить описание архитектуры возврата на основе моего вчерашнего текста
- Нарисовать диаграмму компонентов ( У Вани - уже есть, но, возможно, можно улучшить, добавить конкретики), возможно - карту контекстов.
- Создать модель поручения на возврат (uml-диаграмма классов, но с методами)
- Сигнатура метода получения условий возврата (структура ДТО) на базе GlobalReturnRules. Эта сигнатура - фактически ТЗ для будущей US.
- Сигнатуры внешнего АПИ для почта-банка и  для сайта. 
- АПИ внутреннего сервиса возвратов (swagger)

Резюме
Для US получения правил возврата
 - Готовим диаграммы последовательностей и компонентов. Новую и старую. На диаграммах должен поместиться директ
 - Решаем, как передаются данные из GlobalReturnRules в новый контекст (распределенные транзакции, кеш, но вряд ли).
Возможно, в будущем они просто должны целиком в новый контекст.
 - Думаем про отдельный компонент для работы с GlobalRetrunRules.  
 - Оформляем интерфейс Soap (или в новом компоненте он будет уже не soap)
 - Параллельно можно с Жигуновым обсуждать рефакторинг базы (например, если из команды у кого-то появится свободное время, можно загрузить)

Для всего эпика с архитектурой
 - Диаграммы компонентов и последовательностей
 - Надо описать правила (алгоритмы) трансформации правил возврата и данных из заказа в поручение.
